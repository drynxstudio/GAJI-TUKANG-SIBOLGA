<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Payroll Sync V19</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* CSS Clean & Modern */
        :root{--p:#1e293b;--a:#3b82f6;--bg:#f8fafc;--card:#fff;--brd:#e2e8f0;--txt:#334155;}
        *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        body{margin:0;padding:0;font-family:'Inter',sans-serif;background:var(--bg);color:var(--txt);padding-bottom:100px}
        
        /* HEADER */
        .head{background:var(--p);color:#fff;padding:20px;border-radius:0 0 24px 24px;box-shadow:0 4px 20px rgba(0,0,0,0.1)}
        .inp-t{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#fff;padding:10px;border-radius:8px;width:100%;margin-bottom:10px;outline:none;font-weight:600}
        .status-badge{position:absolute;top:20px;right:20px;background:rgba(0,0,0,0.4);padding:5px 10px;border-radius:20px;font-size:0.7rem;display:flex;align-items:center;gap:5px;border:1px solid rgba(255,255,255,0.2)}
        .dot{width:8px;height:8px;border-radius:50%;background:#ccc}
        .dot.ok{background:#4ade80;box-shadow:0 0 5px #4ade80}
        .dot.load{background:#facc15;animation:pulse 1s infinite}
        @keyframes pulse{50%{opacity:0.5}}
        .tot-box{margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.1);display:flex;justify-content:space-between;align-items:center}
        .tot-v{font-size:1.3rem;font-weight:800;color:#93c5fd}

        /* CONTROLS */
        .ctl-wrap{padding:20px;display:flex;flex-direction:column;gap:10px}
        .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .ctl{padding:12px;border:1px solid var(--brd);border-radius:10px;width:100%;background:#fff;outline:none}
        .arch-msg{background:#fff7ed;color:#c2410c;padding:10px;border-radius:8px;text-align:center;font-size:0.85rem;font-weight:600;display:none}

        /* LIST */
        .list{padding:0 20px;display:flex;flex-direction:column;gap:12px}
        details.c{background:#fff;border:1px solid var(--brd);border-radius:12px;overflow:hidden;box-shadow:0 2px 5px rgba(0,0,0,0.03)}
        details.c[open]{border-color:var(--a)}
        summary.h{padding:15px;cursor:pointer;list-style:none;display:flex;justify-content:space-between;align-items:center}
        summary.h::-webkit-details-marker{display:none}
        .role{font-size:0.7rem;text-transform:uppercase;background:#f1f5f9;padding:2px 6px;border-radius:4px;font-weight:700;color:#64748b}
        .bar{display:flex;height:6px;background:#e2e8f0;border-radius:3px;margin:10px 0}
        .seg{flex:1;border-right:1px solid #fff}
        .bg1{background:#10b981} .bg05{background:#8b5cf6} .bg0{background:transparent}
        .c-body{padding:15px;background:#f8fafc;border-top:1px solid var(--brd)}
        .btns{display:flex;gap:10px;margin-top:15px}
        .btn{flex:1;padding:12px;border-radius:8px;border:none;font-weight:600;cursor:pointer}
        .b-w{background:#fff;border:1px solid var(--brd)}
        .b-b{background:var(--a);color:#fff}
        .b-r{background:#fee2e2;color:#ef4444}

        /* MODAL */
        .mod{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:900;align-items:center;justify-content:center;backdrop-filter:blur(3px)}
        .mod.on{display:flex}
        .box{background:#fff;width:90%;max-width:450px;border-radius:20px;padding:25px;max-height:90vh;overflow-y:auto}
        .bulk{display:flex;gap:5px;margin-bottom:15px;padding-bottom:15px;border-bottom:1px dashed var(--brd)}
        .bk-btn{flex:1;font-size:0.75rem;padding:8px;background:#f1f5f9;border-radius:20px;text-align:center;cursor:pointer;border:1px solid var(--brd)}
        
        .row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #f1f5f9}
        .rads{display:flex;gap:5px}
        .rd{padding:5px 10px;background:#f1f5f9;border-radius:15px;font-size:0.8rem;cursor:pointer;display:flex;align-items:center;gap:5px}
        .rd input{display:none} .rd span{width:10px;height:10px;border-radius:50%;border:2px solid #ccc}
        .rd input:checked+span{background:var(--a);border-color:var(--a)}
        .iot{width:40px;padding:5px;border:1px solid var(--brd);border-radius:5px;text-align:center}

        .fab{position:fixed;bottom:25px;right:25px;width:60px;height:60px;background:var(--a);color:#fff;border-radius:50%;font-size:30px;display:flex;justify-content:center;align-items:center;box-shadow:0 10px 25px rgba(37,99,235,0.4);border:none;cursor:pointer}
        
        /* ANALYTICS */
        .anl{padding:20px;margin-top:20px;border-top:1px dashed var(--brd)}
        details.rep{background:#fff;border:1px solid var(--brd);border-radius:12px;margin-bottom:10px;overflow:hidden}
        details.rep summary{padding:15px;background:#f8fafc;font-weight:600;cursor:pointer;list-style:none}
        .print-btn{width:100%;padding:15px;background:var(--p);color:#fff;font-weight:700;border-radius:12px;border:none;margin-top:15px}

        /* PRINT */
        #print{display:none}
        @media print{
            body{background:#fff}
            .head,.ctl-wrap,.list,.fab,.mod,.anl,#loader{display:none!important}
            #print{display:block;position:absolute;top:0;left:0;width:100%;padding:20px}
            table{width:100%;border-collapse:collapse;font-size:10px;font-family:sans-serif;margin-bottom:20px}
            th,td{border:1px solid #000;padding:5px}
            th{background:#eee!important;-webkit-print-color-adjust:exact;text-align:center}
            .tr{text-align:right} .tc{text-align:center}
            .tot-t{width:50%;margin-left:auto;border:2px solid #000}
            .g-tr{background:#ddd!important;-webkit-print-color-adjust:exact}
            .sign{display:flex;justify-content:space-around;margin-top:50px}
            .sign div{width:30%;text-align:center}
            .l{border-bottom:1px solid #000;margin-top:60px}
        }
        
        /* LOADER */
        #loader{position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;z-index:999;display:flex;flex-direction:column;align-items:center;justify-content:center}
        .spin{width:40px;height:40px;border:4px solid #e2e8f0;border-top:4px solid var(--a);border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
    </style>
</head>
<body>

<div id="loader"><div class="spin"></div><p style="margin-top:15px;font-weight:600;color:#64748b">Sinkronisasi Database...</p></div>

<div class="head">
    <div class="status-badge"><div class="dot" id="dot"></div><span id="st">Init...</span></div>
    <div style="margin-bottom:10px">
        <input id="pN" class="inp-t" style="font-weight:700;font-size:1.1rem" placeholder="Nama Proyek" onchange="upMeta()">
        <input id="vN" class="inp-t" placeholder="Nama Vendor" onchange="upMeta()">
    </div>
    <div class="tot-box"><span>TOTAL MINGGU INI</span><div class="tot-v" id="dT">Rp 0</div></div>
</div>

<div class="ctl-wrap">
    <div class="grid">
        <select id="sel" class="ctl" onchange="loadView()"><option value="c">Minggu Ini (Aktif)</option></select>
        <button onclick="arch()" class="ctl" style="background:var(--p);color:#fff;font-weight:bold">Arsipkan</button>
    </div>
    <div class="grid"><input type="date" id="dS" class="ctl" onchange="save()"><input type="date" id="dE" class="ctl" onchange="save()"></div>
    <div id="amsg" class="arch-msg">‚ö†Ô∏è MODE ARSIP (Edit Only)</div>
</div>

<div id="list" class="list"></div>
<button class="fab" onclick="opA()">+</button>

<div class="anl">
    <details class="rep"><summary onclick="rTrend()">üìà Trend Keuangan</summary><div style="padding:15px"><canvas id="cT" height="200"></canvas></div></details>
    <details class="rep"><summary onclick="rAll()">üìë Rekap Total</summary><div style="padding:15px"><canvas id="cA" height="200"></canvas></div></details>
    <button class="print-btn" onclick="window.print()">üñ®Ô∏è Cetak Nota PDF</button>
</div>

<div id="mA" class="mod"><div class="box"><h3>Tambah Pekerja</h3><form onsubmit="add(event)"><input id="nA" class="ctl" placeholder="Nama" required style="margin-bottom:10px"><select id="cA" class="ctl" style="margin-bottom:10px"><option>Tukang</option><option>Kernet</option><option>Mandor</option></select><div class="grid"><input type="number" id="rA" class="ctl" value="150000"><input type="number" id="oA" class="ctl" value="25000"></div><div class="btns" style="margin-top:20px"><button type="button" class="btn b-w" onclick="cl('mA')">Batal</button><button type="submit" class="btn b-b">Simpan</button></div></form></div></div>

<div id="mE" class="mod">
    <div class="box">
        <h3 style="margin-top:0">Edit: <span id="eN" style="color:var(--a)"></span></h3>
        <div class="bulk">
            <div class="bk-btn" onclick="bulk(1)">‚úÖ Full Semua</div>
            <div class="bk-btn" onclick="bulk(0.5)">¬Ω Setengah Semua</div>
            <div class="bk-btn" onclick="bulkOt()">üïí Lembur Semua</div>
        </div>
        <form onsubmit="upd(event)">
            <div id="eR"></div>
            <div class="btns" style="margin-top:20px">
                <button type="button" class="btn b-w" onclick="cl('mE')">Batal</button>
                <button type="submit" class="btn b-b">Update</button>
            </div>
        </form>
    </div>
</div>

<div id="print">
    <div style="text-align:center;border-bottom:3px double #000;padding-bottom:10px;margin-bottom:15px">
        <h2 style="margin:0">NOTA PEMBAYARAN UPAH</h2>
        <div style="display:flex;justify-content:space-between;font-size:11px;margin-top:5px">
            <span>Proyek: <b id="pp"></b> | Vendor: <b id="pv"></b></span><span>Periode: <b id="pt"></b></span>
        </div>
    </div>
    <table>
        <thead>
            <tr><th rowspan="2">No</th><th rowspan="2">Nama</th><th rowspan="2">Jab</th><th colspan="2">Tarif</th><th colspan="7">Absensi</th><th colspan="3">Rekap</th><th colspan="2">Bayar (Rp)</th><th rowspan="2">TOTAL</th></tr>
            <tr><th>Hr</th><th>Jm</th><th>S</th><th>S</th><th>R</th><th>K</th><th>J</th><th>S</th><th>M</th><th>HK</th><th>¬Ω</th><th>J</th><th>Pokok</th><th>Lembur</th></tr>
        </thead>
        <tbody id="pb"></tbody>
    </table>
    <div style="display:flex;justify-content:flex-end"><table class="tot-t"><tr><td>Gaji Pokok</td><td class="tr" id="pgp"></td></tr><tr><td>Lembur</td><td class="tr" id="pgl"></td></tr><tr class="g-tr"><td>TOTAL TAGIHAN</td><td class="tr" id="pgt"></td></tr></table></div>
    <div class="sign"><div>Disetujui,<div style="font-size:10px;font-weight:bold">Site Manager</div><div class="l"></div>( ................. )</div><div>Dibuat,<div style="font-size:10px;font-weight:bold">Mandor</div><div class="l"></div>( ................. )</div></div>
</div>

<script>
    // ==========================================
    // PASTE URL SCRIPT ANDA DISINI
    // ==========================================
    const API = "https://script.google.com/macros/s/AKfycbyWrfr0Ji917MlPksOZxWYXigMJlI0IoIGX__pLCj8VUbNcu7ClH7bgxdN6YKkYzbj3HA/exec";
    // ==========================================

    const dys=['Sen','Sel','Rab','Kam','Jum','Sab','Min'];
    let d={c:{w:[],start:'',end:''},h:[],m:{p:'',v:''}};
    let idx=-1; let tmr; let ch1,ch2;
    const f=n=>new Intl.NumberFormat('id-ID').format(n);

    // --- SYSTEM ---
    async function init(){
        if(API.includes("PASTE")) return alert("URL Script Belum Diisi!");
        try{
            const r=await fetch(API);
            const j=await r.json();
            if(j){
                d.c = j.current || {w:[],start:'',end:''};
                d.h = j.history || [];
                d.m = j.meta || {p:'',v:''};
                if(!Array.isArray(d.c.w)) d.c.w=[];
                if(!Array.isArray(d.h)) d.h=[];
            }
            st('ok','Online');
        }catch(e){console.log(e);st('err','Offline');}
        
        document.getElementById('loader').style.display='none';
        renSel(); view();
    }

    function st(s,t){
        const d=document.getElementById('dot'), tx=document.getElementById('st');
        d.className='dot '+ (s==='busy'?'load':s==='ok'?'ok':''); tx.innerText=t;
    }

    function sync(){
        st('busy','Saving...');
        if(tmr) clearTimeout(tmr);
        tmr = setTimeout(async ()=>{
            try{
                await fetch(API,{method:'POST',mode:'no-cors',body:JSON.stringify({current:d.c,history:d.h,meta:d.m})});
                st('ok','Saved');
            }catch(e){st('err','Fail');}
        },2000);
    }

    // --- DATA ---
    function cur(){ const s=document.getElementById('sel').value; return s==='c'?d.c:d.h[s]; }
    
    function view(){
        const c=cur();
        document.getElementById('pN').value=d.m.p;
        document.getElementById('vN').value=d.m.v;
        document.getElementById('dS').value=c.start||'';
        document.getElementById('dE').value=c.end||'';
        document.getElementById('amsg').style.display = document.getElementById('sel').value!=='c'?'block':'none';
        ren();
    }

    function save(){
        const c=cur(); c.start=document.getElementById('dS').value; c.end=document.getElementById('dE').value;
        ren(); sync();
    }
    function upMeta(){ d.m.p=document.getElementById('pN').value; d.m.v=document.getElementById('vN').value; sync(); }

    function renSel(){
        const s=document.getElementById('sel');
        s.innerHTML='<option value="c">Minggu Ini (Aktif)</option>';
        d.h.forEach((h,i)=>s.innerHTML+=`<option value="${i}">Arsip: ${h.start} - ${h.end}</option>`);
    }

    function ren(){
        const l=document.getElementById('list'), pb=document.getElementById('pb');
        l.innerHTML=''; pb.innerHTML='';
        const wks=cur().w||[];
        let tg=0, tp=0, tl=0;

        if(wks.length===0) l.innerHTML='<div style="text-align:center;padding:30px;color:#999">Data Kosong</div>';

        wks.forEach((w,i)=>{
            if(!w.att) w.att=Array(7).fill({val:0,ot:0});
            let hk=0, hf=0, ot=0, bar='', cells='';
            
            w.att.forEach(a=>{
                const v=a.val||0;
                if(v===1)hk++; else if(v===0.5)hf++;
                ot+=(a.ot||0);
                
                let c='bg0'; if(v===1)c='bg1'; if(v===0.5)c='bg05';
                bar+=`<div class="seg ${c}"></div>`;
                cells+=`<td class="tc">${v===1?'1':v===0.5?'¬Ω':'-'}</td>`;
            });

            const gp = (hk*w.rate) + (hf*w.rate*0.5);
            const go = ot*w.otRate;
            const tt = gp+go;
            tg+=tt; tp+=gp; tl+=go;

            l.innerHTML+=`
            <details class="c">
                <summary class="h">
                    <div><h3 style="margin:0">${w.name}</h3><span class="role">${w.cat}</span></div>
                    <div style="font-weight:700;color:var(--a)">Rp ${f(tt)}</div>
                </summary>
                <div class="c-body">
                    <div class="bar">${bar}</div>
                    <div style="font-size:0.8rem;display:flex;justify-content:space-between;color:#64748b;margin-bottom:10px">
                        <span>Hadir: <b>${hk}</b> | ¬Ω: <b>${hf}</b></span><span>Lembur: <b>${ot}h</b></span>
                    </div>
                    <div class="btns">
                        <button class="btn b-w" onclick="edt(${i})">üìù Edit</button>
                        <button class="btn b-r" onclick="del(${i})">üóë Hapus</button>
                    </div>
                </div>
            </details>`;

            pb.innerHTML+=`<tr><td class="tc">${i+1}</td><td>${w.name}</td><td>${w.cat}</td><td class="tr">${f(w.rate)}</td><td class="tr">${f(w.otRate)}</td>${cells}<td class="tc">${hk}</td><td class="tc">${hf}</td><td class="tc">${ot}</td><td class="tr">${f(gp)}</td><td class="tr">${f(go)}</td><td class="tr" style="font-weight:bold">${f(tt)}</td></tr>`;
        });

        document.getElementById('dT').innerText="Rp "+f(tg);
        document.getElementById('pgp').innerText="Rp "+f(tp);
        document.getElementById('pgl').innerText="Rp "+f(tl);
        document.getElementById('pgt').innerText="Rp "+f(tg);
        document.getElementById('pp').innerText=d.m.p;
        document.getElementById('pv').innerText=d.m.v;
        document.getElementById('pt').innerText=cur().start+' s/d '+cur().end;
    }

    // --- ACTIONS ---
    function opA(){ document.getElementById('mA').className='mod on'; }
    function cl(id){ document.getElementById(id).className='mod'; }
    function add(e){
        e.preventDefault();
        const w={id:Date.now(), name:document.getElementById('nA').value, cat:document.getElementById('cA').value, rate:Number(document.getElementById('rA').value), otRate:Number(document.getElementById('oA').value), att:Array(7).fill({val:0,ot:0})};
        cur().w.push(w); save(); cl('mA'); document.getElementById('nA').value='';
    }
    function del(i){ if(confirm('Hapus?')){ cur().w.splice(i,1); save(); } }

    function edt(i){
        idx=i; const w=cur().w[i];
        document.getElementById('eN').innerText=w.name;
        const c=document.getElementById('eR'); c.innerHTML='';
        w.att.forEach((a,x)=>{
            c.innerHTML+=`
            <div class="row">
                <div style="font-weight:bold;width:30px">${dys[x]}</div>
                <div class="rads">
                    <label class="rd"><input type="radio" name="d${x}" value="1" ${a.val==1?'checked':''}><span></span>Full</label>
                    <label class="rd"><input type="radio" name="d${x}" value="0.5" ${a.val==0.5?'checked':''}><span></span>¬Ω</label>
                    <label class="rd"><input type="radio" name="d${x}" value="0" ${a.val==0?'checked':''}><span></span>Abs</label>
                </div>
                <input type="number" id="o${x}" value="${a.ot}" class="iot">
            </div>`;
        });
        document.getElementById('mE').className='mod on';
    }

    // BULK FIX
    function bulk(v){
        for(let i=0;i<7;i++){
            const rs=document.getElementsByName('d'+i);
            for(let r of rs) if(Number(r.value)===v) r.checked=true;
        }
    }
    function bulkOt(){
        const v=prompt('Jam lembur semua?','1');
        if(v) for(let i=0;i<7;i++) document.getElementById('o'+i).value=v;
    }

    function upd(e){
        e.preventDefault();
        const w=cur().w[idx];
        for(let i=0;i<7;i++){
            const rs=document.getElementsByName('d'+i);
            let v=0; for(let r of rs) if(r.checked) v=Number(r.value);
            w.att[i]={val:v, ot:Number(document.getElementById('o'+i).value)};
        }
        save(); cl('mE');
    }

    function arch(){
        if(!d.c.start || !d.c.end) return alert('Isi Tanggal dulu');
        if(confirm('Arsipkan?')){
            d.h.unshift(JSON.parse(JSON.stringify(d.c)));
            d.c.w.forEach(w=>w.att=Array(7).fill({val:0,ot:0}));
            d.c.start=''; d.c.end='';
            renSel(); view(); sync();
        }
    }

    // ANALYTICS
    function rTrend(){
        setTimeout(()=>{
            const l=[],v=[];
            for(let i=d.h.length-1;i>=0;i--){
                let t=0; d.h[i].w.forEach(w=>{
                    let h=0,o=0; w.att.forEach(a=>{if(a.val==1)h++;else if(a.val==0.5)h+=0.5; o+=a.ot});
                    t+=(h*w.rate)+(o*w.otRate);
                });
                l.push(d.h[i].end); v.push(t);
            }
            if(ch1)ch1.destroy();
            ch1=new Chart(document.getElementById('cT'),{type:'line',data:{labels:l,datasets:[{label:'Total',data:v,borderColor:'#3b82f6',fill:true}]}});
        },100);
    }
    function rAll(){
        setTimeout(()=>{
            const m={};
            const p=(wk)=>wk.forEach(w=>{
                if(!m[w.name])m[w.name]=0;
                let h=0,o=0; w.att.forEach(a=>{if(a.val==1)h++;else if(a.val==0.5)h+=0.5; o+=a.ot});
                m[w.name]+=(h*w.rate)+(o*w.otRate);
            });
            d.h.forEach(h=>p(h.w)); p(d.c.w);
            const s=Object.entries(m).sort((a,b)=>b[1]-a[1]);
            if(ch2)ch2.destroy();
            ch2=new Chart(document.getElementById('cA'),{type:'bar',indexAxis:'y',data:{labels:s.map(x=>x[0]),datasets:[{label:'Total',data:s.map(x=>x[1]),backgroundColor:'#10b981'}]}});
        },100);
    }

    init();
</script>
</body>
</html>
